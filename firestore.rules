rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- 推奨する新しいルール ---
    // /users/{userId} 以下に、各ユーザーのデータを保存する

    // ユーザー本人のみ、自分のドキュメント以下の情報（例: quiz_attempts）を読み書きできる
    match /users/{userId}/{documents=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // --- 既存のAPI (/api/quiz/submit) が使っているコレクションに対するルール ---
    // このままではセキュアではないため、将来的には上記 users サブコレクションへの移行を推奨します。
    // ひとまず、ログインしているユーザーであれば誰でも書き込み可能にしています。
    match /quiz_attempts/{attemptId} {
      allow create: if request.auth != null;
      // 誰の解答履歴も見られないように、readは拒否
      allow read, update, delete: if false;
    }

    // 他のコレクション（例: modules）へのアクセスルールも必要に応じて追加してください。
    // 例えば、学習モジュールは誰でも読み取り可能にする場合：
    match /modules/{moduleId} {
      allow read: if true;
      allow write: if false; // クライアントからの書き込みは禁止
    }
  }
}