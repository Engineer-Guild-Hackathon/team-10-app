rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // 公開教材は誰でも読める（書き込み禁止）
    match /modules/{moduleId} {
      allow read: if true;
      allow write: if false;
    }

    // アクティブセッションのハートビート（短命な存在）
    // クライアントは開始/終了時のみ作成・削除を行う
    match /active_sessions/{sessionId} {
      // 認証不要で可: 心拍用途で機微情報なし
      allow create, delete: if true;
      allow read, update: if false;
    }

    // 個人のルートドキュメントは本人のみ
    match /users/{uid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    // クイズ解答履歴は本人のみ閲覧可。書き込みはサーバー(API)経由のみとするため拒否
    match /users/{uid}/quiz_attempts/{docId} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow create, update, delete: if false;
    }

    // 学習セッションの保存（サーバーのみ書き込み）。本人のみ閲覧可
    match /sessions/{uid}/items/{sessionId} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow create, update, delete: if false;
    }

    // コラボはまず閉じる（必要になったらAPI経由で）
    match /rooms/{roomId} {
      allow read, write: if false;
    }
    // Rooms: public read-only; server-only writes
    match /rooms/{roomId} {
      allow read: if resource.data.isPublic == true;
      allow create, update, delete: if false;
    }

    // Attempts: user-only read; server-only writes
    match /attempts/{uid}/items/{id} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow create, update, delete: if false;
    }
  }
}
